---
output:
  pdf_document: default
  html_document: default
---

# FORMULA 1 CHAMPIONSHIP EDA AND WINNER PREDICTION

# Loading libraries

```{r}
library(ggplot2)
library(dplyr)
library(rpart)
library(corrplot)
library(treemap)
```

# Data cleansing and pre-processing

```{r}
head(results)
```

```{r}
head(status)
```

```{r}
head(drivers)
```

```{r}
head(races)
```

```{r}
head(constructors)
```

```{r}
head(races)
```

```{r}
head(constructors)
```

```{r}
head(circuits)
```

```{r}
head(constructor_standings)
```

Dropping unwanted columns from results.

```{r}
results = results[-c(12:15)]
colnames(results)[7] = 'finalposition'
```

Merging status in results

```{r}
df.results.merged = merge(results, status, by = c('statusId'))
df.results.merged = df.results.merged %>% relocate(statusId, .after = last_col())
```

Merging drivers in df results

```{r}
#pasting forename and surname in a new column 'fullname' in drivers df.
drivers$fullname = paste(drivers$forename, drivers$surname)
names(drivers$nationality) = 'driv_nationality' #renaming driver's nationality column
drivers_copy = drivers_copy[-c(3, 4, 9)]  #creating with only columns to be merged with results

df.results.merged = merge(df.results.merged, drivers_copy, by = c('driverId'))
```

Merging races with df.results.merged

```{r}
races_copy = races[, c(1,3:6)]
df.results.merged = merge(df.results.merged, races_copy, by = c('raceId'))
```

Merging constructors with df results

```{r}
constructors_copy = constructors[, c(1,3)]
colnames(df.results.merged)[22] = 'const_name'

df.results.merged = merge(df.results.merged, constructors_copy, by = 'constructorId')
df.results.merged = df.results.merged[,-c(20)]
```

Merging circuits with df results.

```{r}
circuits_copy = circuits[, c(1,3)]

df.results.merged = merge(df.results.merged, circuits_copy, by = c('circuitId'))
```

Merging constructor standings with df.result for importing constructor wins and points

```{r}
const_standing_copy = constructor_standings[, c(2,3,4,7)]
colnames(const_standing_copy)[c(3:4)] = c('const_points', 'const_wins')

df.results.merged = merge(df.results.merged, const_standing_copy, by = c('raceId', 'constructorId'))
```

Processing some data columns.

```{r}
#casting fastestLapSpeed to numeric
df.results.merged$fastestLapSpeed = as.numeric(df.results.merged$fastestLapSpeed)

#substitute NA's in fastestSpeed with 0.
df.results.merged$fastestLapSpeed[is.na(df.results.merged$fastestLapSpeed)] <- 0

#Calculating drivers age and adding a relative column to the dataset
df.results.merged$driver_age = as.integer(format(df.results.merged$date, format="%Y"))- as.integer(format(df.results.merged$dob, format="%Y"))

#convert fastest lap time in number of milliseconds 
df.results.merged$fastestLap_ms = as.numeric(lubridate::ms(as.character(df.results.merged$fastestLapTime)))*1000
df.results.merged$fastestLap_ms[is.na(df.results.merged$fastestLap_ms)] <- 0
df.results.merged = df.results.merged[, -c(11)]  #dropping column of old fastestLapTime 
```

Assigning merged dataframe to a new variable called df.

```{r}
df = df.results.merged
```

## EDA and plots.

```{r}
ggplot(df, aes(x=driver_age)) + 
 geom_histogram(aes(y=..density..), colour="black", fill= '#076fa2')+
 geom_density(alpha=.2, fill="#FF6666") +
 labs(title = 'Histogram of driver age')

```

```{r}
ggplot(df, aes(x=driver_age)) +
  geom_boxplot(fill='#076fa2', color="black")+
  theme_classic() +
  labs(title = "Drivers' Age", x = "Drivers' Age")
```

```{r}
ggplot(subset(df, df$fastestLapSpeed > 100), aes(x=fastestLapSpeed)) + 
 geom_histogram(aes(y=after_stat(density)), colour="black", fill= '#076fa2')+
 geom_density(alpha=.2, fill="#FF6666") +
 labs(title = 'Histogram for fastest speed in a lap', x = 'Speed')
```

```{r}
nationality = data.frame(table(df$driv_nationality))
nationality$Var1 = as.character(nationality$Var1)
treemap(nationality, index = 'Var1', vSize = 'Freq')

```

```{r}
ggplot(df, aes(name)) + 
  labs(x = 'Circuits') +
  ggtitle('Circuits Frequency') +
  geom_bar(fill="#076fa2", position = position_dodge(0.7)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 6)) 
  
```

Number of collisions for each circuit.

```{r}
#barplot showing number of collisions for each circuit
n_collision <- table(df[df$status == 'Collision', 'name'])
n_collision <- as.data.frame(n_collision)

ggplot(n_collision, aes(x = Var1, y = Freq)) + 
  labs(x = 'Circuits') +
  ggtitle('Number of collisions per circuit') +
  geom_bar(fill="#076fa2", position = position_dodge(0.7), stat = 'identity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 6)) 
```

Accident ratio for each circuit.

```{r}
#get circuit names for which there was a collision
accident_names = names(table(df[df$status == 'Accident', 'name']))

#barplot showing accident ratio (n^Accident/n^races per circuit)
par(mar=c(3, 7, 2, 1))
barplot(
  (table(df.results.merged[df.results.merged$status == 'Accident', 'name']))/(table(df.results.merged[, 'name'])[accident_names]),
  horiz = TRUE, 
  las=1, 
  cex.names=0.4
  )

#CONTROLLARE RATIO
n_accident <- table(df[df$status == 'Accident', 'name'])
n_accident <- as.data.frame(n_accident)
accident_ratio <- c()
for (i in 1:nrow(n_accident)) {
  accident_ratio <- n_accident$Freq/sum(n_accident$Freq)
}
n_accident['ratio'] <- accident_ratio
ggplot(n_accident, aes(x = Var1, y = ratio)) + 
  labs(x = 'Circuits') +
  ggtitle('Accident ratio per circuit') +
  geom_bar(fill="#076fa2", position = position_dodge(0.7), stat = 'identity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 6)) 

```

Recall function for winner age for.

```{r}
df_year_winner = winner_Age()
names(df_year_winner) = c('year', 'driverId', 'final_points', 'fullname', 'age')

df_year_winner
```

Winning driver age overtime

```{r}
#plot for winner's age over time
ggplot(df_year_winner, aes(x = year, y = age)) + 
  labs(x = 'Years', y = 'Age') +
  ggtitle('Winning driver age for every year') +
  geom_bar(stat = "identity") + 
  geom_col(fill = "#076fa2") +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust = 1)) +
  geom_abline(slope = 0, intercept = mean(df_year_winner$age), color = 'red', size = 1.5)  
```

How important is the pole position in each circuit to win the race?

```{r}
ggplot(pole_ratio, aes(x = X1, y = X2)) + 
  labs(x = 'Circuit', y = 'Ratio') +
  ggtitle('How important is the pole position') +
  geom_bar(stat = "identity") + 
  geom_col(fill = "#076fa2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.margin = margin(0,0,1,1.5, "cm"))
```

Correlation

```{r}
#CORRELATION MATRIX for numerical features
corr_matrix = cor(df.results.merged[c(7,8,9,10,11,16,20,21,22,23)])
corrplot(corr_matrix)
```

### DEFINING AND TRAINING ML MODELS FOR PREDICTION.
